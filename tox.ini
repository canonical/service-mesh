[tox]
no_package = True
skip_missing_interpreters = True
env_list = lint, static, istio
min_version = 4.0.0

[vars]
tst_path = {toxinidir}/tests/
uv_flags = --frozen --isolated

[testenv]
allowlist_externals =
    bash
    uv
    tofu
basepython = python3
setenv =
    PYTHONPATH = {toxinidir}
    PYTHONBREAKPOINT = ipdb.set_trace
    PY_COLORS = 1
passenv =
    PYTHONPATH
    HOME
    PATH
    MODEL_SETTINGS
    HTTP_PROXY
    HTTPS_PROXY
    NO_PROXY
    JUJU_CONTROLLER
    JUJU_MODEL
    JUJU_DATA
    KEEP_MODELS
    ISTIO_CHANNEL

[testenv:lock]
description = Update uv.lock with the latest deps
commands =
    uv lock --upgrade --no-cache

[testenv:lint]
description = Lint the code
commands =
    uv run {[vars]uv_flags} --with ruff ruff check {[vars]tst_path}

[testenv:static]
description = Run static checks
commands =
    uv run {[vars]uv_flags} --with pyright pyright {[vars]tst_path}

[testenv:fmt]
description = Format the code
commands =
    uv run {[vars]uv_flags} --with ruff ruff check --fix {[vars]tst_path}
    uv run {[vars]uv_flags} --with ruff ruff format {[vars]tst_path}
    # terraform files formatting; requires opentofu snap (classic)
    tofu fmt -recursive

[testenv:terraform-fmt]
description = Format terraform files
commands =
    tofu fmt -recursive

[testenv:terraform-validate]
description = Validate terraform configuration
commands =
    bash -c "cd terraform/bookinfo && tofu init -backend=false && tofu validate"
    bash -c "cd terraform/istio && tofu init -backend=false && tofu validate"

[testenv:istio]
description = Run Istio integration tests using pytest-bdd
allowlist_externals =
    uv
commands_pre =
    uv sync --frozen
passenv =
    {[testenv]passenv}
commands =
    uv run --frozen pytest -v {toxinidir}/tests/integration/istio {posargs}
